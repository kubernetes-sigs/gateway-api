# GEP-1651: Cluster Local Gateways

* Issue: [#1651](https://github.com/kubernetes-sigs/gateway-api/issues/1651)
* Status: Provisional

(See status definitions [here](overview.md#status).)

## TLDR

Allow users to configure a Gateway so that it is only accessible within a 
single cluster. We call this a cluster local Gateway.

## Goals

- Cluster local Gateways can be created in a declarative way
- Addresses used by the cluster local gateway are only accessible within a 
  single cluster

## Non-Goals

- Determining 'visibility' on a per-request basis
- Not a lightweight service mesh

## Introduction

One of the early feature requests for Knative was the ability to deploy an 
application using Knative's HTTP routing support, but make it only available 
within the cluster. I want to be able to specify both the "internal" 
(service.namespace.svc) and "external" (service.namespace.example.com).
Gateways using the same GatewayClass on the cluster, but ensure that the 
"internal" service is only reachable within the cluster. This would greatly 
simplify deployment for users over the instructions we have today.

The reason why we require an "internal" Gateway is so we can take advantage of 
layer 7 load balancing for our internal services.

## API

We propose to add a new `AddressType` named `ClusterIP`. When it's 
corresponding `value` field is set to an empty string the implementation shall 
default the IP address to one that is accessible only within the cluster.


```yaml
apiVersion: gateway.networking.k8s.io/v1beta1
kind: Gateway
metadata:
  name: prod-web
spec:
  gatewayClassName: acme-lb
  listeners:  
  - protocol: HTTP
    port: 80
  addresses:
  - type: ClusterIP
```

If an end-user wishes to request a specific value they may set `value` 
explicitly in the spec.

```yaml
apiVersion: gateway.networking.k8s.io/v1beta1
kind: Gateway
metadata:
  name: prod-web
spec:
  gatewayClassName: acme-lb
  listeners:  
  - protocol: HTTP
    port: 80
  addresses:
  - type: ClusterIP
    value: 10.0.0.8
```


## Alternatives


### Survey of Prior Art

These alternatives are a survey of existing approaches to support cluster
local Gateways. Most are implementation specific and are not portable.

#### Special annotation/label

Istio let's you specify an annotation `networking.istio.io/service-type` to 
change the underlying Kubernetes Service type to make it a ClusterIP type.

#### Re-use of AddressType Hostname

Istio let's you re-use existing Gateway deployments by setting the address
type to `Hostname` and the value to the Istio ingress Kubernetes Service. If an 
operator configures the Istio deployment to support cluster local traffic a 
Gateway implementation can select it using the `HostName` attribute.

#### Multiple Gateway Classes

Some implementations support mulitiple deployments on a single cluster where
each maps to a GatewayClass. One of these deployments can be configured to serve
cluster local traffic.


## References

- Knative - Private Services - https://knative.dev/docs/serving/services/private-services/#configuring-private-services
- Initial Gateway GitHub Discussion - https://github.com/kubernetes-sigs/gateway-api/discussions/1247
- Istio Support for Private Gateways - https://istio.io/latest/docs/tasks/traffic-management/ingress/gateway-api/#automated-deployment
