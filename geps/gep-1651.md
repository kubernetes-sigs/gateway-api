# GEP-1651: GatewayAddress Scope

* Issue: [#1651](https://github.com/kubernetes-sigs/gateway-api/issues/1651)
* Status: Provisional

(See status definitions [here](overview.md#status).)

## TLDR

Allow users to configure a GatewayAddress so that it is only accessible within
a specific scope (ie. public/cluster local)

## Goals

- Cluster local gateways can be created in a declarative way `ClusterLocal` and
  are only accessible within a single cluster
- Define a `Public` scope for addresses that are accessible to the internet
- Implementations can define & support their own scopes

## Non-Goals

- Per-request/route scope
- Not a lightweight service mesh

## Introduction

One of the early feature requests for Knative was the ability to deploy an 
application using Knative's HTTP routing support, but make it only available
within the cluster. I want to be able to specify both the "internal" 
(service.namespace.svc) and "external" (service.namespace.example.com). 
Gateways using the same GatewayClass on the cluster, but ensure that the 
"internal" service is only reachable within the cluster. This would greatly 
simplify deployment for users over the instructions we have today.

The reason why we require an "internal" Gateway is so we can take advantage of 
layer 7 load balancing for our internal services.

## API

We propose extending the `GatewayAddress` type to allow end-users to specify
the accessibility of the requested address using a property named `Scope`. 

`GatewayAddress.Value` is now an `optional` field. This allows users to signal
their intent for the implementation to dynamically choose an address based on
the attributes `GatewayAddress.Scope` and `GatewayAddress.Type`.

### Predefined Scopes

Implementations MAY implement the following supplied scopes and MUST abide by 
their defined accessibility

Scope | Accessibility
-|-
`Public`|The address is accessible over the public internet
`ClusterLocal`|The address is accessible only within the local cluster

### Vendor prefixed scopes

Implementations can define custom scopes by specifying a vendor prefix followed
by a slash `/` and a custom scope name ie. `com.ingress.dev/my-scope`.

### Default scope
The default value of `scope` is implementation specific. It is RECOMMENDED that
the default `scope` remains consistent for Gateways with the same
`gatewayClassName`.


## Examples

#### 1. Request a GatewayAddress that is only accessible within a cluster

```yaml
apiVersion: gateway.networking.k8s.io/v1beta1
kind: Gateway
metadata:
  name: prod-web
spec:
  gatewayClassName: acme-lb
  listeners:  
  - protocol: HTTP
    port: 80
  addresses:
  - scope: ClusterLocal
```
#### 2. Request a GatewayAddress with a specific scope and address
```yaml
apiVersion: gateway.networking.k8s.io/v1beta1
kind: Gateway
metadata:
  name: prod-web
spec:
  gatewayClassName: acme-lb
  listeners:  
  - protocol: HTTP
    port: 80
  addresses:
  - scope: ClusterLocal
    value: 10.0.0.8
```
#### 3. Request a GatewayAddress that is publically accessible
```yaml
apiVersion: gateway.networking.k8s.io/v1beta1
kind: Gateway
metadata:
  name: prod-web
spec:
  gatewayClassName: acme-lb
  listeners:  
  - protocol: HTTP
    port: 80
  addresses:
  - scope: Public
```

## Alternatives

### Introducing new GatewayAddress Types

We could introduce additional `AddressTypes` (ie. `ClusterLocalIPAddress`) but
this would lead to a combinatorial explosion as new dimensions (ie. IPv6) are
introduced.

See examples in this comment: https://github.com/kubernetes-sigs/gateway-api/pull/1653#issuecomment-1451246877

### Survey of Prior Art

These alternatives are a survey of existing approaches to support cluster
local Gateways. Most are implementation specific and are not portable.

#### Special annotation/label

Istio let's you specify an annotation `networking.istio.io/service-type` to 
change the underlying Kubernetes Service type to make it a ClusterIP type.

#### Re-use of AddressType Hostname

Istio let's you re-use existing Gateway deployments by setting the address
type to `Hostname` and the value to the Istio ingress Kubernetes Service. If an 
operator configures the Istio deployment to support cluster local traffic a 
Gateway implementation can select it using the `HostName` attribute.

#### Multiple Gateway Classes

Some implementations support multiple deployments on a single cluster where
each maps to a GatewayClass. One of these deployments can be configured to serve
cluster local traffic.


## References

- Knative - Private Services - https://knative.dev/docs/serving/services/private-services/#configuring-private-services
- Initial Gateway GitHub Discussion - https://github.com/kubernetes-sigs/gateway-api/discussions/1247
- Istio Support for Private Gateways - https://istio.io/latest/docs/tasks/traffic-management/ingress/gateway-api/#automated-deployment

