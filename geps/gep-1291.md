# GEP-1291: `Mesh` resource

- Issue: [#1291](https://github.com/kubernetes-sigs/gateway-api/issues/1291)
- Status: Provisional

## TLDR

GAMMA implementations need a way to report conformance and CRD compatibility.
This GEP proposes a `Mesh` resource.

## Goals

The initial `Mesh` resource should provide:

1. Visibility into supported features
1. CRD version compatibility

It is intended to exist in a 1-1 correspondence to an implementation installation/control
plane.

This GEP also serves as a place to build consensus on the need for a `Mesh`
resource at all. Note for clarity, this `Mesh` is essentially the `MeshClass`
mentioned in [the doc from the linked issue](https://github.com/kubernetes-sigs/gateway-api/issues/1291#issuecomment-1209625419).

## Current non-goals

- The possibility of standardizing the `Mesh` as a `targetRef` resource for policy that should apply to all workloads
  in a `Mesh` is put aside for a later iteration.
- This GEP does not address a `Mesh` resource for use by Kubernetes operators
  (the controller pattern, not the role).
- Holding configuration for mesh installations (so no `parametersRef`)

## Proposal

The `Mesh` resource is analogous to `GatewayClass` in some ways but plays a
slightly different role in that `Mesh` does not quite represent a particular class of
infrastructure. The current version of this GEP sees `Mesh`
primarily as an informational resource, rather than a place for configuration.

It is _cluster-scoped_.

Analogous to `GatewayClass`, a GAMMA implementation can choose whether to create
a `Mesh` resource on install or manage them after creation by users.
However, a GAMMA conformant implementation MUST only manage GAMMA `Routes`
if it has accepted a corresponding `Mesh` resource.

### Spec

The spec contains a reference to the GAMMA-conformant controller and a description.

```go
type MeshSpec struct {
	// ControllerName is the name of the controller that is managing GAMMA-conformant
    // HTTPRoutes in this cluster. The value of this field MUST be a domain prefixed path.
	//
	// Example: "example.net/gamma-controller".
	//
	// This field is not mutable and cannot be empty.
	//
	// Support: Core
	//
	// +kubebuilder:validation:XValidation:message="Value is immutable",rule="self == oldSelf"
	ControllerName GatewayController `json:"controllerName"`

	// Description helps describe a Mesh with more details.
	//
	// +kubebuilder:validation:MaxLength=64
	// +optional
	Description *string `json:"description,omitempty"`
}
```

#### `parametersRef`

As discussed, there's not yet a concrete, documented use case for allowing for
multiple `Meshes` with different configuration at present, so we leave out `parametersRef`.
Mesh implementations already look for their configuration elsewhere.

Supporting mesh-wide configuration might in fact
be a good use case for `Mesh` as a `targetRef.kind` with policy attachment.

### Status

The status is managed by the implementation and reports which GAMMA/Gateway API
features are supported as well as which CRD versions are supported.

```go
type MeshStatus struct {
	// Conditions is the current status from the controller for
	// this Mesh.
	//
	// Controllers should prefer to publish conditions using values
	// of MeshConditionType for the type of each Condition.
	//
	// +optional
	// +listType=map
	// +listMapKey=type
	// +kubebuilder:validation:MaxItems=8
	// +kubebuilder:default={{type: "Accepted", status: "Unknown", message: "Waiting for controller", reason: "Pending", lastTransitionTime: "1970-01-01T00:00:00Z"}}
	Conditions []metav1.Condition `json:"conditions,omitempty"`

	// SupportedFeatures is the set of features the GAMMA implementation supports.
	// It MUST be sorted in ascending alphabetical order.
	// +optional
	// +listType=set
	// <gateway:experimental>
	// +kubebuilder:validation:MaxItems=64
	SupportedFeatures []SupportedFeature `json:"supportedFeatures,omitempty"`
}
```

#### Conditions

The `Mesh` status should contain:

- the `SupportedVersion` condition, analogous to the `GatewayClass` condition, with
  [the same semantics](https://github.com/kubernetes-sigs/gateway-api/blob/68194976485b269e68214b5a40e5951815bbb80b/apis/v1/gatewayclass_types.go#L221).
- the `Accepted` condition, with [analogous semantics](https://github.com/kubernetes-sigs/gateway-api/blob/68194976485b269e68214b5a40e5951815bbb80b/apis/v1beta1/gatewayclass_types.go#L168).

## Alternatives

This GEP leaves open all options except not having any kind of `Mesh` resource
whatsoever.

### Relying on existing Gateway API resources

While this GEP, at present, could be represented via `GatewayClass`, it's likely in
the future that as GAMMA continues, we only accumulate more use cases for
GAMMA-specific resources that don't fit into `GatewayClass`.

Additionally, many mesh implementations themselves support `Gateways`/`GatewayClasses`,
so this would require pushing the semantics of a `GatewayClass` quite far.
