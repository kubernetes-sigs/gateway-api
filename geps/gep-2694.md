# GEP-2694: Support

* Issue: [#2694](https://github.com/kubernetes-sigs/gateway-api/issues/2694)
* Status: Provisional

## TLDR

This GEP proposes adding regex support for path redirects and rewrites.

## Goals

* Replace with a Regular Expression substitution

## API

Although not all gateway APIs support the same regex, it is important
to find a more commonly supported regex and establish a specification.

* Path redirects
* Host rewrites

### Path Modifiers

Both redirects and rewrites would share the same `PathModifier` types:

```go
// HTTPPathModifierType defines the type of path redirect.
type HTTPPathModifierType string

const (
  ...
  // This type of modifier indicates that the full path will be replaced
  // by the specified value. For example, the path `/foo/bar/baz` with a
  // RegularExpression match of `/foo/(.*)/baz`, the `bar` will be replaced
  // with other
  RegularExpressionHTTPPathModifier HTTPPathModifierType = "RegularExpression"
)

// HTTPPathModifier defines configuration for path modifiers.
type HTTPPathModifier struct {
  // Type defines the type of path modifier.
  //
  // +kubebuilder:validation:Enum=Absolute;ReplacePrefixMatch;RegularExpression
  Type HTTPPathModifierType `json:"type"`

  // Substitution defines the HTTP path value to substitute. An empty value ("")
  // indicates that the portion of the path to be changed should be removed from
  // the resulting path. For example, a request to ReplacePrefixMatch "/foo/bar"
  // with a prefix match of "/foo" would be modified to "/bar".
  // the path `/foo/bar/baz` with a RegularExpression match of `/foo/(.*)/baz`,
  // the `bar` will be replaced with other.
  //
  // +kubebuilder:validation:MaxLength=1024
  Substitution string `json:"substitution"`
}
```

## Portability

Different gateway APIs support different regexes, we need to find a widely supported regex.

### Envoy
Envoy supports the following relevant capabilities

* RE2 ([reference](https://www.envoyproxy.io/docs/envoy/latest/api-v3/type/matcher/v3/regex.proto))
* Hyperscan ([reference](https://www.envoyproxy.io/docs/envoy/latest/api-v3/extensions/matching/input_matchers/hyperscan/v3alpha/hyperscan.proto.html))

### Google Cloud
Google Cloud URL Maps support the following relevant capabilities

* RE2 ([reference](https://github.com/google/re2/wiki/Syntax))

### HAProxy
HAProxy supports the following relevant capabilities

* PCRE ([reference](https://www.haproxy.com/documentation/haproxy-configuration-tutorials/http-rewrites/#rewriting-anywhere-in-the-request-using-regexes))

### NGINX
The NGINX rewrite module contains the following relevant capabilities

* PCRE ([reference](http://nginx.org/en/docs/http/ngx_http_rewrite_module.html))

### KONG

* PCRE ([reference](https://discuss.konghq.com/t/a-few-words-on-regex-uris-usage-and-common-pitfalls/506))

## Alternatives

### 1. Why RE2
If there's a regex type that needs to be chosen eventually, RE2 is more appropriate.
Although the number of gateway APIs supporting RE2 and PCRE are similar when looking over them
at the moment, there are much more compelling reasons for RE2 to be used.

* Kubernetes only accept expressions in ingress that comply with the RE2 engine syntax.
* RE2 syntax is a subset of that accepted by PCRE. This means that the syntax of RE2 can be parsed by the PCRE.

### 2. Regex Compatibility
In the realm of regex, there is no way to perfectly unify regex specific implementations from
what is available. According to the existing way of handling, a better solution is to let users
decide their own implementation, and not to make restrictions at the API level. For a more
user-friendly experience, documentation of the type of Different gateway APIs support regexes
is available (That's acceptable).

## References

Issues:

- [#2177: Support regex based path rewrites](https://github.com/kubernetes-sigs/gateway-api/issues/2177)
- [#2694: Enhancment: HTTPRoute support match by RegularExpression](https://github.com/kubernetes-sigs/gateway-api/issues/2694)

Pull Request:

- [#639: Add note about "implementation-specific" vs conformance levels](https://github.com/kubernetes-sigs/gateway-api/pull/639)