# GEP-2694: Support

* Issue: [#2694](https://github.com/kubernetes-sigs/gateway-api/issues/2694)
* Status: Provisional

## TLDR

This GEP proposes adding regex support for path **redirects and rewrites**.

## Goals

* Enable replacements with a [Regular Expression] substitution

## API

Although not all Gateway API implementations support the same regex engines, it is important to find a more commonly supported regex and establish a specification.

* Path redirects
* Host rewrites

### Proposal

If there's a regex type that needs to be chosen eventually, RE2 is more appropriate.
Although the number of gateway APIs supporting RE2 and PCRE are similar when looking over them
at the moment, there are much more compelling reasons for RE2 to be used.

* Kubernetes only accept expressions in ingress that comply with the RE2 engine syntax.
* RE2 syntax is a subset of that accepted by PCRE. This means that the syntax of RE2 can be parsed by the PCRE.

### Path Modifiers

Both redirects and rewrites would share the same `PathModifier` types:

```go

// HTTPPathModifierType defines the type of path redirect or rewrite.
type HTTPPathModifierType string

const (
  ...
  // This type of modifier indicates that the full path will be replaced
  // by the specified value. For example, the path `/foo/bar/baz` with a
  // RegularExpression match of `/foo/(.*)/baz`, the `bar` will be replaced
  // with other
  RegularExpressionHTTPPathModifier HTTPPathModifierType = "RegularExpression"
)

// HTTPPathModifier defines configuration for path modifiers.
type HTTPPathModifier struct {
  // Type defines the type of path modifier.
  //
  // +kubebuilder:validation:Enum=Absolute;ReplacePrefixMatch;RegularExpression
  Type HTTPPathModifierType `json:"type"`

  // Substitution defines the HTTP path value to substitute. An empty value ("")
  // indicates that the portion of the path to be changed should be removed from
  // the resulting path. For example, a request to ReplacePrefixMatch "/foo/bar"
  // with a prefix match of "/foo" would be modified to "/bar".
  // the path `/foo/bar/baz` with a RegularExpression match of `/foo/(.*)/baz`,
  // the `bar` will be replaced with others.
  //
  // +kubebuilder:validation:MaxLength=1024
  Substitution string `json:"substitution"`
}
```

## Portability

Different gateway APIs support different regexes, we need to find a widely supported regex.

| Gateway APIs         | Regex                                                                                                                          |
|----------------------|--------------------------------------------------------------------------------------------------------------------------------|
| Istio                | [RE2](https://istio.io/latest/docs/reference/config/networking/virtual-service/#HTTPMatchRequest)                              |
| Google Cloud         | [RE2](https://cloud.google.com/api-gateway/docs/path-templating)                                                               |
| Cilium               | [RE2](https://github.com/cilium/cilium/blob/69ee9e95a5fd9059605893219b59ccf7297d49c5/api/v1/flow/README.md?plain=1#L348)       |
| Envoy Gateway        | [RE2](https://www.envoyproxy.io/docs/envoy/latest/api-v3/type/matcher/v3/regex.proto)                                          |
| Contour              | [RE2](https://github.com/projectcontour/contour#overview)                                                                      |
| Emissary Ingress     | [RE2](https://github.com/emissary-ingress/emissary/blob/master/CHANGELOG.md#300-june-27-2022)                                  |
| Gloo Edge            | [RE2](https://docs.solo.io/gloo-edge/latest/guides/traffic_management/request_processing/regex_rewrite/)                       |
| Hashicorp Consul     | [RE2](https://developer.hashicorp.com/terraform/language/functions/regex)                                                      |
| Kuma                 | [RE2](https://kuma.io/docs/2.8.x/policies/traffic-metrics/#filter-envoy-metrics)                                               |
| Flomesh Service Mesh | [RE2](https://github.com/flomesh-io/fsm/blob/2d0e40b4a04431b1518a9d4f388b5363cef524be/docs/how_fsm_uses_envoy.md?plain=1#L180) |
| HAProxy              | [PCRE](https://discourse.haproxy.org/t/documentation-about-regex-syntax/2019/3)                                                |
| NGINX                | [PCRE](https://www.f5.com/company/blog/nginx/regular-expression-tester-nginx)                                                  |
| KONG                 | [PCRE](https://docs.konghq.com/gateway/latest/key-concepts/routes/#regular-expressions)                                        |
| HAProxy              | [PCRE](https://discourse.haproxy.org/t/documentation-about-regex-syntax/2019/3)                                                |
| Litespeed            | [PCRE](https://docs.litespeedtech.com/cloud/kubernetes/gateway/#extended-gateway-features)                                     |
| Traefik              | [REGEXP](https://github.com/search?q=repo%3Atraefik%2Ftraefik+regexp&type=code)                                                |

## Alternatives

In the realm of regex, there is no way to perfectly unify regex specific implementations from
what is available. According to the existing way of handling, a better solution is to let users
decide their own implementation, and not to make restrictions at the API level. For a more
user-friendly experience, documentation of the type of Different gateway APIs support regexes
is available (That's acceptable).

## References

Issues:

- [#2177: Support regex based path rewrites](https://github.com/kubernetes-sigs/gateway-api/issues/2177)
- [#2694: Enhancment: HTTPRoute support match by RegularExpression](https://github.com/kubernetes-sigs/gateway-api/issues/2694)

Pull Request:

- [#639: Add note about "implementation-specific" vs conformance levels](https://github.com/kubernetes-sigs/gateway-api/pull/639)