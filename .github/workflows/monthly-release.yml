name: Monthly Release

on:
  schedule:
    # Run on the first day of every month at 00:00 UTC
    - cron: "0 0 1 * *"
  workflow_dispatch:
    # Allow manual triggering
    inputs:
      tag:
        description: "Monthly tag (e.g., monthly-2026.01). Leave empty to auto-generate."
        required: false
        type: string

permissions:
  contents: write
  id-token: write
  pull-requests: read

jobs:
  create-monthly-release:
    name: Create Monthly Release
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # tag=v6.0.1
        with:
          fetch-depth: 0 # Fetch all history for release notes

      - name: Set up Go
        uses: actions/setup-go@4dc6199c7b1a012772edbd06daecab0f50c9053c # tag=v6.1.0
        with:
          go-version-file: "go.work"

      - name: Generate monthly tag
        id: tag
        run: |
          if [ -n "${{ inputs.tag }}" ]; then
            TAG="${{ inputs.tag }}"
          else
            # Format: monthly-YYYY.MM
            TAG="monthly-$(date +"%Y.%m")"
          fi
          echo "tag=${TAG}" >> $GITHUB_OUTPUT
          echo "Generated tag: ${TAG}"

      - name: Check if tag already exists
        id: check-tag
        run: |
          if git rev-parse "${{ steps.tag.outputs.tag }}" >/dev/null 2>&1; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "Tag ${{ steps.tag.outputs.tag }} already exists, skipping release"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Create and push tag
        if: steps.check-tag.outputs.exists == 'false'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag "${{ steps.tag.outputs.tag }}"
          git push origin "${{ steps.tag.outputs.tag }}"

      - name: Build monthly YAML
        if: steps.check-tag.outputs.exists == 'false'
        env:
          TAG: ${{ steps.tag.outputs.tag }}
          MONTHLY_NONINTERACTIVE: "true"
        run: |
          make build-monthly-yaml

      - name: Generate release notes
        if: steps.check-tag.outputs.exists == 'false'
        id: release-notes
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: |
          TAG="${{ steps.tag.outputs.tag }}"

          # Extract year and month for the header
          YEAR_MONTH=$(echo "$TAG" | sed 's/monthly-//')
          YEAR=$(echo "$YEAR_MONTH" | cut -d. -f1)
          MONTH_NUM=$(echo "$YEAR_MONTH" | cut -d. -f2)

          case "$MONTH_NUM" in
            01) MONTH_NAME="January" ;;
            02) MONTH_NAME="February" ;;
            03) MONTH_NAME="March" ;;
            04) MONTH_NAME="April" ;;
            05) MONTH_NAME="May" ;;
            06) MONTH_NAME="June" ;;
            07) MONTH_NAME="July" ;;
            08) MONTH_NAME="August" ;;
            09) MONTH_NAME="September" ;;
            10) MONTH_NAME="October" ;;
            11) MONTH_NAME="November" ;;
            12) MONTH_NAME="December" ;;
            *) MONTH_NAME="Month $MONTH_NUM" ;;
          esac

          # Find previous tag and SHAs for PR extraction
          # Ensure we have history
          git fetch --tags --force

          PREV_TAG=$(git tag -l "monthly-*" | sort -V | grep -B1 "^${TAG}$" | head -n1)

          if [ -z "$PREV_TAG" ] || [ "$PREV_TAG" == "$TAG" ]; then
            # Fallback if first monthly release: go back ~30 days
            START_SHA=$(git rev-list -n 1 --before="1 month" origin/main)
          else
            START_SHA=$(git rev-parse "$PREV_TAG")
          fi
          END_SHA=$(git rev-parse HEAD)

          # 4. Create the mandatory Header
          {
            printf 'Gateway API %s Release Notes\n\n' "${TAG}"
            printf 'This is the monthly release for the Gateway API experimental channel for %s %s. This release includes the latest features and fixes from Gateway API'\''s main branch.\n\n' "${MONTH_NAME}" "${YEAR}"
            printf 'Using this Release\n\n'
            printf 'To install the CRDs for this release, use install %s-install.yaml:\n\n' "${TAG}"
            printf '```\n'
            printf 'kubectl apply --server-side=true -f https://github.com/kubernetes-sigs/gateway-api/releases/download/%s/%s-install.yaml\n' "${TAG}" "${TAG}"
            printf '```\n\n'
            printf 'To build using this release in Go, include this release in your go.mod:\n\n'
            printf '```\n'
            printf 'require sigs.k8s.io/gateway-api %s\n' "${TAG}"
            printf '```\n\n'
            printf 'and run go mod tidy. You'\''ll find that %s gets replaced by a Go pseudoversion; this is expected.\n\n' "${TAG}"
            printf 'Changes Summary\n\n'
          } > release-notes.md

          # Extract PR numbers from git log and format as links
          printf '### Merged Pull Requests\n\n' >> release-notes.md

          # Get all PR numbers from commit messages between START_SHA and END_SHA
          # PRs are typically referenced as #1234, fixes #1234, closes #1234, etc.
          # Also check merge commit messages which often contain "Merge pull request #1234"
          PR_NUMBERS=$(git log --format="%s %B" "${START_SHA}..${END_SHA}" | grep -oE '(#[0-9]+|pull request #[0-9]+)' | grep -oE '[0-9]+' | sort -u -n)

          if [ -n "$PR_NUMBERS" ]; then
            for PR_NUM in $PR_NUMBERS; do
              # Get PR title and author from GitHub API
              PR_DATA=$(curl -s -H "Authorization: token ${GITHUB_TOKEN}" \
                -H "Accept: application/vnd.github.v3+json" \
                "https://api.github.com/repos/${GITHUB_REPOSITORY}/pulls/${PR_NUM}" 2>/dev/null || echo "")
              
              if [ -n "$PR_DATA" ]; then
                PR_TITLE=$(echo "$PR_DATA" | grep -o '"title":"[^"]*"' | head -1 | cut -d'"' -f4 || echo "")
                PR_AUTHOR=$(echo "$PR_DATA" | grep -o '"login":"[^"]*"' | head -1 | cut -d'"' -f4 || echo "")
              fi
              
              # Fallback: get from commit message if API fails
              if [ -z "$PR_TITLE" ]; then
                COMMIT_MSG=$(git log --format="%s" "${START_SHA}..${END_SHA}" | grep -m1 "#${PR_NUM}" || echo "")
                if [ -n "$COMMIT_MSG" ]; then
                  PR_TITLE=$(echo "$COMMIT_MSG" | sed 's/.*#'"${PR_NUM}"'[^:]*: *//' | sed 's/^Merge pull request.*//' | head -c 100)
                fi
                [ -z "$PR_TITLE" ] && PR_TITLE="PR #${PR_NUM}"
              fi
              
              if [ -z "$PR_AUTHOR" ]; then
                # Fallback: get author from commit that mentions this PR
                PR_AUTHOR=$(git log --format="%an" --grep="#${PR_NUM}" "${START_SHA}..${END_SHA}" | head -1 || echo "unknown")
              fi
              
              PR_URL="https://github.com/${GITHUB_REPOSITORY}/pull/${PR_NUM}"
              printf '- %s by @%s in [#%s](%s)\n' "$PR_TITLE" "$PR_AUTHOR" "$PR_NUM" "$PR_URL" >> release-notes.md
              
              # Small delay to avoid rate limiting
              sleep 0.1
            done
          else
            printf 'No pull requests found in this release.\n' >> release-notes.md
          fi

          printf '\n' >> release-notes.md

          # Add Full Changelog link at the end
          if [ -n "$PREV_TAG" ] && [ "$PREV_TAG" != "$TAG" ]; then
            COMPARE_URL="https://github.com/${GITHUB_REPOSITORY}/compare/${PREV_TAG}...${TAG}"
            printf '\nFull Changelog: [%s...%s](%s)\n' "${PREV_TAG}" "${TAG}" "${COMPARE_URL}" >> release-notes.md
          else
            printf '\nFull Changelog: See commit history\n' >> release-notes.md
          fi

      - name: Create GitHub Release
        if: steps.check-tag.outputs.exists == 'false'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.tag.outputs.tag }}
          name: Monthly Release ${{ steps.tag.outputs.tag }}
          body_path: release-notes.md
          prerelease: true
          files: |
            release/${{ steps.tag.outputs.tag }}-install.yaml
          draft: false
          generate_release_notes: false

      - name: Summary
        if: always()
        run: |
          if [ "${{ steps.check-tag.outputs.exists }}" == "true" ]; then
            echo "## ⚠️ Release Skipped" >> $GITHUB_STEP_SUMMARY
            echo "Tag ${{ steps.tag.outputs.tag }} already exists. No release was created." >> $GITHUB_STEP_SUMMARY
          else
            echo "## ✅ Release Created" >> $GITHUB_STEP_SUMMARY
            echo "Successfully created monthly release: **${{ steps.tag.outputs.tag }}**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "View the release: https://github.com/${{ github.repository }}/releases/tag/${{ steps.tag.outputs.tag }}" >> $GITHUB_STEP_SUMMARY
          fi
