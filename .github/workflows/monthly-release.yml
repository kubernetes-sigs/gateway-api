name: Monthly Release

on:
  # TODO: Uncomment below code after we have released monthly couple of times.
  # Until then, we will manually trigger the workflow.
  # schedule:
    # Run on the first day of every month at 00:00 UTC
    # - cron: "0 0 1 * *"
  workflow_dispatch:
    # Allow manual triggering
    inputs:
      tag:
        description: "Monthly tag (e.g., monthly-2026.01). Leave empty to auto-generate."
        required: false
        type: string

permissions:
  contents: write
  id-token: write
  pull-requests: read

jobs:
  create-monthly-release:
    name: Create Monthly Release
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # tag=v6.0.2
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@4b73464bb391d4059bd26b0524d20df3927bd417 # tag=v6.3.0
        with:
          go-version-file: "go.work"

      - name: Generate monthly tag
        id: tag
        run: |
          if [ -n "${{ inputs.tag }}" ]; then
            TAG="${{ inputs.tag }}"
          else
            # Format: monthly-YYYY.MM
            TAG="monthly-$(date +"%Y.%m")"
          fi
          echo "tag=${TAG}" >> $GITHUB_OUTPUT
          # Extract year.month for the release title (e.g., monthly-2026.01 -> 2026.01)
          YEAR_MONTH=$(echo "${TAG}" | sed 's/monthly-//')
          echo "year_month=${YEAR_MONTH}" >> $GITHUB_OUTPUT
          echo "Generated tag: ${TAG}"

      - name: Check if tag already exists
        run: |
          if git rev-parse "${{ steps.tag.outputs.tag }}" >/dev/null 2>&1; then
            echo "Error: Tag ${{ steps.tag.outputs.tag }} already exists, aborting release!"
            exit 1
          fi

      - name: Create and push tag
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag "${{ steps.tag.outputs.tag }}"
          git push origin "${{ steps.tag.outputs.tag }}"

      - name: Build monthly YAML
        env:
          TAG: ${{ steps.tag.outputs.tag }}
          MONTHLY_NONINTERACTIVE: "true"
        run: |
          make build-monthly-yaml

      - name: Release with notes
        id: release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: |
          TAG="${{ steps.tag.outputs.tag }}"
          YEAR_MONTH=$(echo ""${{ steps.tag.outputs.year_month }}"" | sed 's/\./-/')
          YEAR=$(echo "$YEAR_MONTH" | cut -d- -f1)
          MONTH_NAME=$(date -d "${YEAR_MONTH}-01" +"%B")

          git fetch --tags --force

          PREV_TAG=$(git tag -l "monthly-*" | sort -V | grep -B1 "^${TAG}$" | head -n1)

          if [ -z "$PREV_TAG" ] || [ "$PREV_TAG" == "$TAG" ]; then
            START_SHA=$(git rev-list -n 1 --before="1 month" origin/main)
          else
            START_SHA=$(git rev-parse "$PREV_TAG")
          fi
          END_SHA=$(git rev-parse HEAD)

          # Create the release notes header from template
          export TAG MONTH_NAME YEAR
          envsubst < .github/workflows/release-notes-header.template.md > release-notes.md

          if [ -n "$PREV_TAG" ] && [ "$PREV_TAG" != "$TAG" ]; then
            # Add Full Changelog link
            printf '\n' >> release-notes.md
            COMPARE_URL="https://github.com/${GITHUB_REPOSITORY}/compare/${PREV_TAG}...${TAG}"
            printf 'Full Changelog: [%s...%s](%s)\n' "${PREV_TAG}" "${TAG}" "${COMPARE_URL}" >> release-notes.md
            printf '\n' >> release-notes.md

            SINCE_DATE=$(git log -1 --format=%aI "${PREV_TAG}")
            DUE_DATE=$(git log -1 --format=%aI "${TAG}")
            echo "SINCE_DATE: ${SINCE_DATE}"
            echo "DUE_DATE: ${DUE_DATE}"
            
            echo "## Merged Pull Requests (${PREV_TAG} to ${TAG})" >> release-notes.md
            
            gh pr list \
              --base main \
              --state merged \
              --search "merged:${SINCE_DATE}..${DUE_DATE}" \
              --limit 500 \
              --json number,title,author \
              --template '{{range .}}* {{.title}} (#{{.number}}) @{{.author.login}}{{"\n"}}{{end}}' >> release-notes.md

          else
            printf '### Merged Pull Requests\n\n'
            printf 'No pull requests found in this release.\n' >> release-notes.md
          fi

          gh release create ${{ steps.tag.outputs.tag }} \
            -F release-notes.md \
            --prerelease \
            --draft release/${{ steps.tag.outputs.tag }}-install.yaml

      - name: Cleanup
        if: always()
        run: |
          rm -f release-notes.md

      - name: Summary
        if: success()
        run: |
          echo "## âœ… Release Created" >> $GITHUB_STEP_SUMMARY
          echo "Successfully created monthly release: **${{ steps.tag.outputs.tag }}**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "View the release: https://github.com/${{ github.repository }}/releases/tag/${{ steps.tag.outputs.tag }}" >> $GITHUB_STEP_SUMMARY
