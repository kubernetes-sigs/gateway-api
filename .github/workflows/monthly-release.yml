name: Monthly Release

on:
    schedule:
        # Run on the first day of every month at 00:00 UTC
        - cron: "0 0 1 * *"
    workflow_dispatch:
        # Allow manual triggering
        inputs:
            tag:
                description: "Monthly tag (e.g., monthly-2026.01). Leave empty to auto-generate."
                required: false
                type: string

permissions:
    contents: write
    id-token: write

jobs:
    create-monthly-release:
        name: Create Monthly Release
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # tag=v6.0.1
              with:
                  fetch-depth: 0 # Fetch all history for release notes

            - name: Set up Go
              uses: actions/setup-go@4dc6199c7b1a012772edbd06daecab0f50c9053c # tag=v6.1.0
              with:
                go-version-file: 'go.work'

            - name: Generate monthly tag
              id: tag
              run: |
                  if [ -n "${{ inputs.tag }}" ]; then
                    TAG="${{ inputs.tag }}"
                  else
                    # Format: monthly-YYYY.MM
                    TAG="monthly-$(date +"%Y.%m")"
                  fi
                  echo "tag=${TAG}" >> $GITHUB_OUTPUT
                  echo "Generated tag: ${TAG}"

            - name: Check if tag already exists
              id: check-tag
              run: |
                  if git rev-parse "${{ steps.tag.outputs.tag }}" >/dev/null 2>&1; then
                    echo "exists=true" >> $GITHUB_OUTPUT
                    echo "Tag ${{ steps.tag.outputs.tag }} already exists, skipping release"
                  else
                    echo "exists=false" >> $GITHUB_OUTPUT
                  fi

            - name: Create and push tag
              if: steps.check-tag.outputs.exists == 'false'
              run: |
                  git config user.name "github-actions[bot]"
                  git config user.email "github-actions[bot]@users.noreply.github.com"
                  git tag "${{ steps.tag.outputs.tag }}"
                  git push origin "${{ steps.tag.outputs.tag }}"

            - name: Build monthly YAML
              if: steps.check-tag.outputs.exists == 'false'
              env:
                  TAG: ${{ steps.tag.outputs.tag }}
                  MONTHLY_NONINTERACTIVE: "true"
              run: |
                  make build-monthly-yaml

            - name: Generate release notes
              if: steps.check-tag.outputs.exists == 'false'
              id: release-notes
              run: |
                  TAG="${{ steps.tag.outputs.tag }}"
                  YEAR_MONTH=$(echo "$TAG" | sed 's/monthly-//')
                  YEAR=$(echo "$YEAR_MONTH" | cut -d. -f1)
                  MONTH_NUM=$(echo "$YEAR_MONTH" | cut -d. -f2)

                  # 1. Calculate Previous Month/Year for the comparison
                  if [ "$MONTH_NUM" = "01" ]; then
                      PREV_MONTH="12"; PREV_YEAR=$((YEAR - 1))
                  else
                      PREV_MONTH=$(printf "%02d" $((10#$MONTH_NUM - 1)))
                      PREV_YEAR=$YEAR
                  fi
                  
                  TARGET_PREV_TAG="monthly-$PREV_YEAR.$PREV_MONTH"

                  if git rev-parse "$TARGET_PREV_TAG" >/dev/null 2>&1; then
                      PREV_TAG="$TARGET_PREV_TAG"
                  else
                      PREV_TAG=$(git describe --tags --abbrev=0 "${TAG}^" 2>/dev/null || echo "main")
                  fi

                  # 2. Get Month Name for the header
                  MONTH_NAME=$(date -d "$YEAR-$MONTH_NUM-01" +"%B" 2>/dev/null || echo "Month $MONTH_NUM")

                  # 3. Build the Notes
                  {
                    echo "# Gateway API ${TAG} Release Notes"
                    echo ""
                    echo "This is the monthly release for the Gateway API experimental channel for **${MONTH_NAME} ${YEAR}**."
                    echo ""
                    echo "## Installation"
                    echo "\`\`\`bash"
                    echo "kubectl apply --server-side=true -f https://github.com/${{ github.repository }}/releases/download/${TAG}/${TAG}-install.yaml"
                    echo "\`\`\`"
                    echo ""
                    echo "---"
                    
                    # Modified CRDs
                    CHANGED_FILES=$(git diff --name-only ${PREV_TAG}..${TAG} -- config/crd/experimental 2>/dev/null || echo "")
                    if [ -n "$CHANGED_FILES" ]; then
                        echo "### ðŸ›  Modified Experimental CRDs"
                        echo "\`\`\`"
                        echo "$CHANGED_FILES" | sed 's|config/crd/experimental/||' | sort | uniq
                        echo "\`\`\`"
                        echo ""
                    fi

                    # Full Commits
                    echo "### ðŸ“ Full Changelog"
                    git log ${PREV_TAG}..${TAG} --no-merges --pretty=format:"* %h %s"
                    echo ""
                    echo ""
                    echo "**Full Diff**: https://github.com/${{ github.repository }}/compare/${PREV_TAG}...${TAG}"
                  } > release-notes.md
              
            - name: Create GitHub Release
              if: steps.check-tag.outputs.exists == 'false'
              uses: softprops/action-gh-release@v2
              with:
                  tag_name: ${{ steps.tag.outputs.tag }}
                  name: Monthly Release ${{ steps.tag.outputs.tag }}
                  body_path: release-notes.md
                  prerelease: true
                  files: |
                      release/${{ steps.tag.outputs.tag }}-install.yaml
                  draft: false
                  generate_release_notes: false

            - name: Summary
              if: always()
              run: |
                  if [ "${{ steps.check-tag.outputs.exists }}" == "true" ]; then
                    echo "## âš ï¸ Release Skipped" >> $GITHUB_STEP_SUMMARY
                    echo "Tag ${{ steps.tag.outputs.tag }} already exists. No release was created." >> $GITHUB_STEP_SUMMARY
                  else
                    echo "## âœ… Release Created" >> $GITHUB_STEP_SUMMARY
                    echo "Successfully created monthly release: **${{ steps.tag.outputs.tag }}**" >> $GITHUB_STEP_SUMMARY
                    echo "" >> $GITHUB_STEP_SUMMARY
                    echo "View the release: https://github.com/${{ github.repository }}/releases/tag/${{ steps.tag.outputs.tag }}" >> $GITHUB_STEP_SUMMARY
                  fi
